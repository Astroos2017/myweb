<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Code 產生器（含 Logo） v0.4</title>
  <style>
    :root{--border:#e5e8f0;--bg:#f5f7fb;--brand:#19a0ff;--muted:#667}
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto; margin:0; background:var(--bg); color:#111}
    .wrap{max-width:980px; margin:32px auto; padding:0 16px; display:grid; grid-template-columns: 1fr 1fr; gap:16px}
    .card{background:#fff; border:1px solid var(--border); border-radius:12px; padding:16px}
    h1{margin:0 0 8px}
    label{display:block; font-size:14px; color:#555; margin:8px 0 6px}
    input[type=text], input[type=number], input[type=url]{width:100%; padding:10px 12px; border:1px solid #cfd6e4; border-radius:10px; outline:none}
    input[type=range]{width:100%}
    .btns{display:flex; gap:8px; margin-top:12px; flex-wrap:wrap}
    button{appearance:none; border:0; background:var(--brand); color:#fff; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer}
    .ghost{background:#eef6ff; color:#0a66b7}
    .preview{min-height:420px; display:flex; align-items:center; justify-content:center}
    #qrContainer canvas{border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .muted{font-size:12px; color:var(--muted)}
    .ver{font-size:12px; color:var(--muted); text-align:right; margin-top:6px}
  </style>
  <script src="./davidshimjs-qrcodejs-04f46c6/qrcode.min.js"></script>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <h1>QR Code 產生器（含 Logo）</h1>

      <label for="text">內容文字或網址</label>
      <input id="text" type="text" placeholder="https://example.com" value="https://example.com" />

      <label for="size">尺寸 (px)</label>
      <input id="size" type="number" min="128" max="2048" step="32" value="400"/>
      <div class="muted">建議 256–512。錯誤更正等級使用 H（適合放 Logo）。</div>

      <hr>

      <label for="logoFile">Logo 檔案（PNG/JPG/SVG）</label>
      <input id="logoFile" type="file" accept="image/*"/>

      <label for="logoUrl">或 Logo 網址（可留白）</label>
      <input id="logoUrl" type="url" placeholder="https://..."/>

      <label for="logoPct">Logo 大小（% 相對於 QR 寬邊） <span id="logoPctVal" class="muted">20%</span></label>
      <input id="logoPct" type="range" min="0" max="60" step="1" value="20"/>
      <div class="muted">提示：過大會影響掃描率，建議 ≤ 30%。</div>

      <hr>

      <label>外框設定</label>
      <div class="muted">自動為 QR 最外圍加上 <strong>2%</strong> 尺寸的白色邊框（無條件進位為整數像素）。</div>

      <div class="btns">
        <button id="btnGen">重新產生</button>
        <button id="btnDownload" class="ghost">下載 PNG</button>
      </div>
      <div class="ver">版本 <span id="verText">v0.4</span></div>
    </section>

    <section class="card preview">
      <div id="qrContainer" aria-label="QR 預覽"></div>
    </section>
  </div>

<script>
  const VERSION = 'v0.4';
  document.getElementById('verText').textContent = VERSION;

  const els = {
    text: document.getElementById('text'),
    size: document.getElementById('size'),
    logoFile: document.getElementById('logoFile'),
    logoUrl: document.getElementById('logoUrl'),
    logoPct: document.getElementById('logoPct'),
    logoPctVal: document.getElementById('logoPctVal'),
    btnGen: document.getElementById('btnGen'),
    btnDownload: document.getElementById('btnDownload'),
    box: document.getElementById('qrContainer'),
  };

  let logoImage = null; // HTMLImageElement（或 null）

  function loadLogoFromFile(file){
    return new Promise((resolve, reject) => {
      if (!file) return resolve(null);
      const reader = new FileReader();
      reader.onload = () => { const img = new Image(); img.onload = () => resolve(img); img.onerror = () => reject(new Error('無法讀取選取的圖片檔')); img.src = reader.result; };
      reader.onerror = () => reject(new Error('讀取檔案失敗'));
      reader.readAsDataURL(file);
    });
  }

  function loadLogoFromUrl(url){
    return new Promise((resolve, reject) => {
      if (!url) return resolve(null);
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => resolve(img);
      img.onerror = () => reject(new Error('無法載入 Logo 網址（可能 CORS 或 URL 錯誤）'));
      img.src = url;
    });
  }

  function ensureCanvasFromContainer(container){
    const img = container.querySelector('img');
    const canvas = container.querySelector('canvas');
    if (canvas) return canvas;
    if (img) {
      const c = document.createElement('canvas');
      c.width = img.naturalWidth || img.width;
      c.height = img.naturalHeight || img.height;
      const ctx = c.getContext('2d');
      ctx.drawImage(img, 0, 0, c.width, c.height);
      container.innerHTML = '';
      container.appendChild(c);
      return c;
    }
    return null;
  }

  function roundRect(ctx, x, y, w, h, r){
    const radius = Math.max(0, Math.min(r, w/2, h/2));
    ctx.beginPath();
    ctx.moveTo(x + radius, y);
    ctx.arcTo(x + w, y, x + w, y + h, radius);
    ctx.arcTo(x + w, y + h, x, y + h, radius);
    ctx.arcTo(x, y + h, x, y, radius);
    ctx.arcTo(x, y, x + w, y, radius);
    ctx.closePath();
  }

  // 僅疊 Logo（保持透明背景）
  function drawLogoOnCanvas(canvas){
    if (!canvas || !logoImage) return;
    const pct = +els.logoPct.value || 0;
    if (pct <= 0) return;

    const ctx = canvas.getContext('2d');
    const side = Math.round(Math.min(canvas.width, canvas.height) * (pct/100));
    const x = Math.round((canvas.width - side)/2);
    const y = Math.round((canvas.height - side)/2);

    ctx.save();
    roundRect(ctx, x, y, side, side, Math.round(side * 0.12));
    ctx.clip();
    ctx.drawImage(logoImage, x, y, side, side);
    ctx.restore();
  }

  // 依尺寸加 2% 白色邊框（向上取整），回傳新 canvas
  function addWhiteBorder(canvas, baseSize){
    const border = Math.ceil(baseSize * 0.02); // 無條件進位
    if (border <= 0) return canvas;
    const out = document.createElement('canvas');
    out.width = canvas.width + border * 2;
    out.height = canvas.height + border * 2;
    const ctx = out.getContext('2d');
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, out.width, out.height);
    ctx.drawImage(canvas, border, border);
    return out;
  }

  function drawQR(){
    const text = els.text.value || ' ';
    const size = Math.max(128, Math.min(2048, +els.size.value || 400));

    els.box.innerHTML = '';
    new QRCode(els.box, {
      text, width: size, height: size,
      colorDark: '#000000',
      colorLight: '#ffffff',
      correctLevel: QRCode.CorrectLevel.H
    });

    requestAnimationFrame(() => {
      let canvas = ensureCanvasFromContainer(els.box);
      if (!canvas) return;
      // 疊 Logo
      drawLogoOnCanvas(canvas);
      // 加外框
      canvas = addWhiteBorder(canvas, size);
      els.box.innerHTML = '';
      els.box.appendChild(canvas);
    });
  }

  // 事件
  els.btnGen.addEventListener('click', () => { try { drawQR(); } catch (err) { alert('產生失敗：' + err); } });
  els.text.addEventListener('keydown', (e) => { if (e.key === 'Enter') els.btnGen.click(); });
  els.logoPct.addEventListener('input', () => { els.logoPctVal.textContent = els.logoPct.value + '%'; drawQR(); });
  els.logoFile.addEventListener('change', async (e) => { try { logoImage = await loadLogoFromFile(e.target.files?.[0]); drawQR(); } catch (err) { alert(err.message || err); } });
  els.logoUrl.addEventListener('change', async (e) => { try { logoImage = await loadLogoFromUrl(e.target.value); drawQR(); } catch (err) { alert(err.message || err); } });
  els.btnDownload.addEventListener('click', () => {
    const canvas = els.box.querySelector('canvas');
    if (!canvas) { alert('尚未產生 QR，或瀏覽器未使用 canvas 呈現。'); return; }
    try { const a = document.createElement('a'); a.download = 'qrcode.png'; a.href = canvas.toDataURL('image/png'); a.click(); } catch (e) { alert('下載失敗：' + e); }
  });

  // 初始
  els.logoPctVal.textContent = els.logoPct.value + '%';
  drawQR();
</script>
</body>
</html>
